# 2.5 – Configuração de Cluster

## Visão Geral

O cluster RabbitMQ será composto por **5 nós** (node00 a node04), conforme descrito em `infra.md`. Todos os nós já devem ter executado os passos de instalação e configuração inicial (2.1, 2.2, 2.3, 2.4).

- **Alta disponibilidade:** Todos os nós participam do cluster, suportando mirrored queues e quorum queues para ambientes críticos.
- **Disc nodes:** Em versões recentes, todos os nós podem ser disc nodes (recomendado para resiliência).

## Configuração de nomes e resolução de hosts

### 1. Resolução de nomes dos nós

**Recomendado para ambientes corporativos:**
- Utilize DNS interno para garantir que todos os nós consigam resolver os nomes uns dos outros (ex: node00, node01, node02, node03, node04).
- O uso de DNS permite mudanças de IP sem impacto para o cluster.

Todos os nós devem conseguir resolver os nomes dos demais para garantir comunicação correta.

## Passos para formar o cluster

### 2. Parar o aplicativo RabbitMQ nos nós secundários
Execute nos nós que vão se juntar ao cluster (node01, node02, node03, node04):
```bash
sudo rabbitmqctl stop_app
```

### 3. Juntar os nós ao cluster
Execute nos nós secundários, sempre apontando para o nó inicial do cluster (node00):
```bash
# No node01
sudo rabbitmqctl join_cluster rabbit@node00
# No node02
sudo rabbitmqctl join_cluster rabbit@node00
# No node03
sudo rabbitmqctl join_cluster rabbit@node00
# No node04
sudo rabbitmqctl join_cluster rabbit@node00
```
> Todos os nós secundários devem se juntar ao cluster iniciado pelo node00. Não utilize rabbit@node01, rabbit@node02, etc. como destino.

### 4. Iniciar o aplicativo RabbitMQ nos nós secundários
```bash
sudo rabbitmqctl start_app
```

### 5. Verificar status do cluster
Em qualquer nó:
```bash
sudo rabbitmqctl cluster_status
```

---

## Melhores práticas para alta disponibilidade

- **Mirrored Queues:**
  - Use políticas para replicar filas críticas entre os nós.
  - Exemplo de política para todas as filas:
    ```bash
    sudo rabbitmqctl set_policy ha-all ".*" '{"ha-mode":"all"}' --priority 1 --apply-to queues
    ```
  - Mirrored queues são recomendadas para compatibilidade, mas para novos projetos prefira quorum queues.

- **Quorum Queues:**
  - São nativamente distribuídas e tolerantes a falhas.
  - Exemplo de criação:
    ```bash
    # No cliente ou via management UI:
    # Defina a fila como tipo 'quorum' ao criar
    ```

- **Sincronização de horário:**
  - Todos os nós devem estar com NTP ativo para evitar problemas de cluster.

---

> **Notas:**
> - O comando `join_cluster` só é executado nos nós que vão se juntar ao cluster (node01 a node04). O node00 é o nó inicial.
> - Todos os nós devem ter as mesmas configurações de usuário, vhost e permissões para garantir consistência.
> - Para ambientes críticos, monitore o cluster e configure alertas para falhas de nó ou de sincronização de filas.
> - A ativação dos plugins de gerenciamento e monitoramento está detalhada nos passos 2.6 e 2.7 deste guia.
> - **Importante:** O suporte a alta disponibilidade (mirrored queues e quorum queues) depende de políticas e configurações aplicadas após o cluster estar formado. A etapa de cluster garante apenas a comunicação entre os nós; a replicação e tolerância a falhas das filas é definida posteriormente, conforme exemplos acima.
