# 2.9 – Setup de HAProxy para RabbitMQ (Instalação Offline)

## Cenário
- Dois nodes HAProxy em alta disponibilidade (HA), atuando como balanceadores para o cluster RabbitMQ.
- Instalação offline, sem acesso à internet.
- HAProxy distribui conexões dos clientes entre os nodes RabbitMQ.

---

## 1. Pré-requisitos
- Pacote HAProxy disponível localmente (RPM ou tar.gz).
- Acesso root nos nodes HAProxy.
- IPs/hosts dos nodes RabbitMQ conhecidos.

---

## 2. Instalação do HAProxy (Offline)
---

## 2.1. Preparação dos nodes dedicados ao HAProxy (03c e 04c)

Para usar os servidores 03c e 04c exclusivamente como HAProxy:


### 1. Pare e desabilite o RabbitMQ nos nodes 03c e 04c
Execute nos próprios nodes 03c e 04c:
```bash
sudo systemctl stop rabbitmq-server
sudo systemctl disable rabbitmq-server
```

### 2. Remova os nodes 03c e 04c do cluster RabbitMQ
Com os serviços já parados, execute em um node ativo do cluster (ex: 00c):
```bash
sudo rabbitmqctl forget_cluster_node rabbit@sncpos00903c
sudo rabbitmqctl forget_cluster_node rabbit@sncpos00904c
```
Isso garante que o cluster não acuse ausência desses nodes e mantenha o status saudável.

> **Observação:** O comando `forget_cluster_node` só funciona corretamente se o serviço RabbitMQ nos nodes a serem removidos estiver parado.


### 3. Instale o HAProxy offline nos nodes 03c e 04c

#### 3.1. Baixe o pacote RPM do HAProxy em um computador com acesso à internet
Versão recomendada: haproxy-2.4.22-1.el9.x86_64.rpm
URL oficial CentOS Stream 9:
```powershell
# Exemplo em ambiente Windows (PowerShell):
curl.exe -o haproxy-2.4.22-1.el9.x86_64.rpm "http://mirror.stream.centos.org/9-stream/AppStream/x86_64/os/Packages/haproxy-2.4.22-1.el9.x86_64.rpm"
```
Confirme o tamanho do arquivo baixado:
```powershell
Get-Item .\haproxy-2.4.22-1.el9.x86_64.rpm | Select-Object Length
```

#### 3.2. Faça o upload do arquivo para o diretório `/tmp` de cada node HAProxy
Use o Painel SFTP (drag-and-drop via MobaXterm) ou SCP:
```powershell
scp C:\caminho\haproxy-2.4.22-1.el9.x86_64.rpm usuario@IP_DO_NODE_HAPROXY:/tmp/
```

#### 3.3. Instale o pacote transferido
No node HAProxy, instale o pacote:
```bash
sudo dnf install /tmp/haproxy-2.4.22-1.el9.x86_64.rpm
```
Se houver dependências, baixe e transfira também os pacotes necessários e instale todos juntos:
```bash
sudo dnf install /tmp/haproxy-2.4.22-1.el9.x86_64.rpm /tmp/dependencia1.rpm /tmp/dependencia2.rpm
```

#### 3.4. Configure o HAProxy normalmente


Abra o arquivo de configuração do HAProxy:
```bash
sudo nano /etc/haproxy/haproxy.cfg
```

Não apague nada! Vá até o final do arquivo usando as setas do teclado.

No final do arquivo, cole o texto do bloco "Exemplo de configuração do HAProxy" (logo abaixo deste passo).

O exemplo começa com:
```
frontend rabbitmq_front
    bind *:5672
    default_backend rabbitmq_nodes
... (veja o exemplo completo no próximo passo)
```

Depois de colar o exemplo, salve e feche o arquivo (`Ctrl+O`, `Enter`, `Ctrl+X` no nano).

Garanta que as permissões do arquivo estejam corretas:
```bash
sudo chown root:root /etc/haproxy/haproxy.cfg
sudo chmod 644 /etc/haproxy/haproxy.cfg
```

Não é necessário alterar as portas do RabbitMQ nos nodes 00c, 01c, 02c.

### 4. Configure o backend do HAProxy para encaminhar para todos os nodes do cluster RabbitMQ ativos (00c, 01c, 02c).

**Vantagens:**
- Nenhum impacto nas aplicações: continuam usando as portas padrão.
- Cluster RabbitMQ permanece intacto e sem alterações de porta.
- HAProxy dedicado, facilitando manutenção e futuras mudanças.

**Exemplo de configuração do HAProxy:**

#### Bloco para AMQP (porta 5672)
```haproxy
frontend rabbitmq_front
    bind *:5672
    default_backend rabbitmq_nodes

backend rabbitmq_nodes
    balance roundrobin
    server sncpos00900c sncpos00900c:5672 check
    server sncpos00901c sncpos00901c:5672 check
    server sncpos00902c sncpos00902c:5672 check
```

#### Bloco para Management UI HTTP (porta 15672)
```haproxy
frontend rabbitmq_mgmt
    bind *:15672
    default_backend rabbitmq_mgmt_nodes

backend rabbitmq_mgmt_nodes
    balance roundrobin
    server sncpos00900c sncpos00900c:15672 check
    server sncpos00901c sncpos00901c:15672 check
    server sncpos00902c sncpos00902c:15672 check
```

#### Bloco para Management UI HTTPS (porta 15671)
```haproxy
frontend rabbitmq_mgmt_ssl
    bind *:15671
    default_backend rabbitmq_mgmt_nodes_ssl

backend rabbitmq_mgmt_nodes_ssl
    balance roundrobin
    server sncpos00900c sncpos00900c:15671 check
    server sncpos00901c sncpos00901c:15671 check
    server sncpos00902c sncpos00902c:15671 check
```

> **Importante:**
> - Realize a desativação do RabbitMQ apenas nos nodes 03c e 04c.
> - Configure o HAProxy para escutar nas portas padrão.
> - As aplicações devem apontar para os IPs/hostnames dos nodes HAProxy (03c e 04c) nas portas padrão.
---

## 2.1. Alteração das portas do RabbitMQ nos nodes 00c e 01c

Para liberar as portas padrão para o HAProxy, altere as portas do RabbitMQ nos nodes 00c e 01c conforme abaixo:

### AMQP (5672 → 5673)
Edite o arquivo de configuração do RabbitMQ:
```bash
sudo nano /etc/rabbitmq/rabbitmq.conf
```
Adicione ou altere a linha:
```
listeners.tcp.default = 5673
```

### Management UI HTTP (15672 → 15673)
No mesmo arquivo ou em `/etc/rabbitmq/rabbitmq.conf`:
```
management.listener.port = 15673
```

### Management UI HTTPS (15671 → 15674)
Se estiver usando TLS, altere:
```
management.listener.ssl.port = 15674
```

### Reinicie o serviço RabbitMQ para aplicar as mudanças:
```bash
sudo systemctl restart rabbitmq-server
```

> **Atenção:**
> - Realize essas alterações apenas nos nodes 00c e 01c.
> - Certifique-se de que as portas configuradas no HAProxy estejam alinhadas com as novas portas do RabbitMQ nestes nodes.
> - Valide que o RabbitMQ está escutando nas novas portas antes de iniciar o HAProxy.


### 2.1. Upload do pacote HAProxy

Em um computador com acesso à internet, baixe o pacote RPM do HAProxy compatível com RHEL 9:
Versão recomendada: haproxy-2.4.22-1.el9.x86_64.rpm
URL oficial CentOS Stream 9:
```powershell
# Exemplo em ambiente Windows (PowerShell):
curl.exe -o haproxy-2.4.22-1.el9.x86_64.rpm "http://mirror.stream.centos.org/9-stream/AppStream/x86_64/os/Packages/haproxy-2.4.22-1.el9.x86_64.rpm"
```
Confirme o tamanho do arquivo baixado:
```powershell
Get-Item .\haproxy-2.4.22-1.el9.x86_64.rpm | Select-Object Length
```

Faça o upload do arquivo para o diretório `/tmp` de cada node HAProxy usando o Painel SFTP (drag-and-drop via MobaXterm) — padrão dos demais docs.

Como alternativa, pode usar SCP:
```powershell
scp C:\caminho\haproxy-2.4.22-1.el9.x86_64.rpm usuario@IP_DO_NODE_HAPROXY:/tmp/
```

### 2.2. Instalação do pacote
No node HAProxy, instale o pacote transferido:
```bash
sudo dnf install /tmp/haproxy-2.4.22-1.el9.x86_64.rpm
```
Se houver dependências, baixe e transfira também os pacotes necessários e instale todos juntos:
```bash
sudo dnf install /tmp/haproxy-2.4.22-1.el9.x86_64.rpm /tmp/dependencia1.rpm /tmp/dependencia2.rpm
```

---

## 3. Configuração do HAProxy


### 3.1. Estratégia recomendada para HAProxy em nodes 00c e 01c

Se o HAProxy será instalado nos mesmos nodes que já rodam RabbitMQ (00c e 01c), siga este modelo para garantir compatibilidade e transparência para as aplicações:

**Passos:**
1. Altere as portas do RabbitMQ nos nodes 00c e 01c para portas alternativas (ex: 5673, 15673, 15674), liberando as portas padrão para o HAProxy.
2. Instale e configure o HAProxy nesses nodes para escutar nas portas padrão (5672, 15672, 15671).
3. Configure o backend do HAProxy para encaminhar para todos os nodes do cluster, incluindo 00c e 01c nas novas portas.
4. As aplicações devem apontar para o IP/hostname dos nodes HAProxy (00c e 01c) nas portas padrão.

**Vantagens:**
- Nenhum impacto para as aplicações: continuam usando as portas padrão.
- Centralização e balanceamento transparente via HAProxy.
- Facilidade para futuras mudanças (Consul, Route53, etc).

**Exemplo de configuração do HAProxy:**

#### Bloco para AMQP (porta 5672)
```haproxy
frontend rabbitmq_front
    bind *:5672
    default_backend rabbitmq_nodes

backend rabbitmq_nodes
    balance roundrobin
    server sncpos00900c sncpos00900c:5673 check
    server sncpos00901c sncpos00901c:5673 check
    server sncpos00902c sncpos00902c:5672 check
    server sncpos00903c sncpos00903c:5672 check
    server sncpos00904c sncpos00904c:5672 check
```

#### Bloco para Management UI HTTP (porta 15672)
```haproxy
frontend rabbitmq_mgmt
    bind *:15672
    default_backend rabbitmq_mgmt_nodes

backend rabbitmq_mgmt_nodes
    balance roundrobin
    server sncpos00900c sncpos00900c:15673 check
    server sncpos00901c sncpos00901c:15673 check
    server sncpos00902c sncpos00902c:15672 check
    server sncpos00903c sncpos00903c:15672 check
    server sncpos00904c sncpos00904c:15672 check
```

#### Bloco para Management UI HTTPS (porta 15671)
```haproxy
frontend rabbitmq_mgmt_ssl
    bind *:15671
    default_backend rabbitmq_mgmt_nodes_ssl

backend rabbitmq_mgmt_nodes_ssl
    balance roundrobin
    server sncpos00900c sncpos00900c:15674 check
    server sncpos00901c sncpos00901c:15674 check
    server sncpos00902c sncpos00902c:15671 check
    server sncpos00903c sncpos00903c:15671 check
    server sncpos00904c sncpos00904c:15671 check
```

> **Importante:**
> - Não insira dentro das seções `global` ou `defaults`.
> - Insira após o bloco `defaults` ou junto aos demais `frontend`/`backend` já existentes.
> - Mantenha a indentação igual aos exemplos acima.
> - Utilize apenas os nomes dos nodes. Certifique-se de que o HAProxy consegue resolver esses nomes via DNS ou `/etc/hosts`.

**Observação:**
- Documente as portas alteradas nos nodes 00c e 01c.
- Oriente os times de desenvolvimento que o acesso ao RabbitMQ será sempre via HAProxy nas portas padrão.
---

## 4. Inicialização do HAProxy
```bash
sudo systemctl enable --now haproxy
sudo systemctl status haproxy
```

---

## 5. Teste de funcionamento
- Conecte um cliente à porta 5672 do HAProxy e verifique se a conexão é distribuída entre os nodes RabbitMQ.
- Teste failover: pare um node RabbitMQ e veja se o HAProxy redireciona para os nodes ativos.

---

## 6. Alta disponibilidade do HAProxy (opcional)
- Para HA real, configure um VIP (Virtual IP) com Keepalived ou Pacemaker entre os dois nodes HAProxy.
- O VIP garante que, se um HAProxy falhar, o outro assume automaticamente.
- Exemplo de configuração de Keepalived pode ser fornecido conforme necessidade.

---

## 7. Observações
- Não é necessário ajuste nos nodes RabbitMQ para uso com HAProxy.
- Garanta que as portas estejam liberadas no firewall dos nodes HAProxy e RabbitMQ.
- Documente os IPs/hosts usados no balanceamento para facilitar troubleshooting.

---

> **Dica:** Para ambientes offline, mantenha todos os pacotes necessários em um repositório local ou mídia removível.
