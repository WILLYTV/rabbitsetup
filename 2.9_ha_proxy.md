# 2.9 – Setup de HAProxy para RabbitMQ (Instalação Offline)

## Cenário
- Dois nodes HAProxy em alta disponibilidade (HA), atuando como balanceadores para o cluster RabbitMQ.
- Instalação offline, sem acesso à internet.
- HAProxy distribui conexões dos clientes entre os nodes RabbitMQ.

---

## 1. Pré-requisitos
- Pacote HAProxy disponível localmente (RPM ou tar.gz).
- Acesso root nos nodes HAProxy.
- IPs/hosts dos nodes RabbitMQ conhecidos.

---

## 2. Instalação do HAProxy (Offline)


### 2.1. Upload do pacote HAProxy
Em um computador com acesso à internet, baixe o pacote RPM do HAProxy compatível com sua versão do RHEL/CentOS:
```powershell
# Exemplo em ambiente Windows (PowerShell):
curl.exe -o haproxy-<versao>.rpm "https://download-url/haproxy-<versao>.rpm"
```
Confirme o tamanho do arquivo baixado:
```powershell
Get-Item .\haproxy-<versao>.rpm | Select-Object Length
```

Faça o upload do arquivo para o diretório `/tmp` de cada node HAProxy usando o Painel SFTP (drag-and-drop via MobaXterm) — padrão dos demais docs.

Como alternativa, pode usar SCP:
```powershell
scp C:\caminho\haproxy-<versao>.rpm usuario@IP_DO_NODE_HAPROXY:/tmp/
```

### 2.2. Instalação do pacote
No node HAProxy, instale o pacote transferido:
```bash
sudo dnf install /tmp/haproxy-<versao>.rpm
```
Se houver dependências, baixe e transfira também os pacotes necessários e instale todos juntos:
```bash
sudo dnf install /tmp/haproxy-<versao>.rpm /tmp/dependencia1.rpm /tmp/dependencia2.rpm
```

---

## 3. Configuração do HAProxy

### 3.1. Edite o arquivo de configuração
- Local: `/etc/haproxy/haproxy.cfg` (ou diretório equivalente)

Exemplo de configuração:
```
frontend rabbitmq_front
    bind *:5672
    default_backend rabbitmq_nodes

backend rabbitmq_nodes
    balance roundrobin
    server node1 10.0.0.1:5672 check
    server node2 10.0.0.2:5672 check
    server node3 10.0.0.3:5672 check
```
- Ajuste os IPs conforme seu cluster.
- Para Management UI (opcional):
```
frontend rabbitmq_mgmt
    bind *:15672
    default_backend rabbitmq_mgmt_nodes

backend rabbitmq_mgmt_nodes
    balance roundrobin
    server node1 10.0.0.1:15672 check
    server node2 10.0.0.2:15672 check
    server node3 10.0.0.3:15672 check
```

---

## 4. Inicialização do HAProxy
```bash
sudo systemctl enable --now haproxy
sudo systemctl status haproxy
```

---

## 5. Teste de funcionamento
- Conecte um cliente à porta 5672 do HAProxy e verifique se a conexão é distribuída entre os nodes RabbitMQ.
- Teste failover: pare um node RabbitMQ e veja se o HAProxy redireciona para os nodes ativos.

---

## 6. Alta disponibilidade do HAProxy (opcional)
- Para HA real, configure um VIP (Virtual IP) com Keepalived ou Pacemaker entre os dois nodes HAProxy.
- O VIP garante que, se um HAProxy falhar, o outro assume automaticamente.
- Exemplo de configuração de Keepalived pode ser fornecido conforme necessidade.

---

## 7. Observações
- Não é necessário ajuste nos nodes RabbitMQ para uso com HAProxy.
- Garanta que as portas estejam liberadas no firewall dos nodes HAProxy e RabbitMQ.
- Documente os IPs/hosts usados no balanceamento para facilitar troubleshooting.

---

> **Dica:** Para ambientes offline, mantenha todos os pacotes necessários em um repositório local ou mídia removível.
