# 2.9 – Setup de HAProxy para RabbitMQ (Instalação Offline)

## Cenário
- Dois nodes HAProxy em alta disponibilidade (HA), atuando como balanceadores para o cluster RabbitMQ.
- Instalação offline, sem acesso à internet.
- HAProxy distribui conexões dos clientes entre os nodes RabbitMQ.

---

## 1. Pré-requisitos
- Pacote HAProxy disponível localmente (RPM ou tar.gz).
- Acesso root nos nodes HAProxy.
- IPs/hosts dos nodes RabbitMQ conhecidos.

---

## 2. Instalação do HAProxy (Offline)


### 2.1. Upload do pacote HAProxy

Em um computador com acesso à internet, baixe o pacote RPM do HAProxy compatível com RHEL 9:
Versão recomendada: haproxy-2.4.22-1.el9.x86_64.rpm
URL oficial CentOS Stream 9:
```powershell
# Exemplo em ambiente Windows (PowerShell):
curl.exe -o haproxy-2.4.22-1.el9.x86_64.rpm "http://mirror.stream.centos.org/9-stream/AppStream/x86_64/os/Packages/haproxy-2.4.22-1.el9.x86_64.rpm"
```
Confirme o tamanho do arquivo baixado:
```powershell
Get-Item .\haproxy-2.4.22-1.el9.x86_64.rpm | Select-Object Length
```

Faça o upload do arquivo para o diretório `/tmp` de cada node HAProxy usando o Painel SFTP (drag-and-drop via MobaXterm) — padrão dos demais docs.

Como alternativa, pode usar SCP:
```powershell
scp C:\caminho\haproxy-2.4.22-1.el9.x86_64.rpm usuario@IP_DO_NODE_HAPROXY:/tmp/
```

### 2.2. Instalação do pacote
No node HAProxy, instale o pacote transferido:
```bash
sudo dnf install /tmp/haproxy-2.4.22-1.el9.x86_64.rpm
```
Se houver dependências, baixe e transfira também os pacotes necessários e instale todos juntos:
```bash
sudo dnf install /tmp/haproxy-2.4.22-1.el9.x86_64.rpm /tmp/dependencia1.rpm /tmp/dependencia2.rpm
```

---

## 3. Configuração do HAProxy


### 3.1. Edite o arquivo de configuração
- Local: `/etc/haproxy/haproxy.cfg` (ou diretório equivalente)

Adicione os blocos abaixo no local apropriado do arquivo, junto aos demais frontends/backends (sem duplicar nomes):

```
frontend rabbitmq_front
    bind *:5672
    default_backend rabbitmq_nodes

backend rabbitmq_nodes
    balance roundrobin
    server sncpos00900c sncpos00900c:5672 check
    server sncpos00901c sncpos00901c:5672 check
    server sncpos00902c sncpos00902c:5672 check
    server sncpos00903c sncpos00903c:5672 check
    server sncpos00904c sncpos00904c:5672 check
```

Para Management UI (opcional):
```
frontend rabbitmq_mgmt
    bind *:15672
    default_backend rabbitmq_mgmt_nodes

backend rabbitmq_mgmt_nodes
    balance roundrobin
    server sncpos00900c sncpos00900c:15672 check
    server sncpos00901c sncpos00901c:15672 check
    server sncpos00902c sncpos00902c:15672 check
    server sncpos00903c sncpos00903c:15672 check
    server sncpos00904c sncpos00904c:15672 check
```

> Utilize apenas os nomes dos nodes. Certifique-se de que o HAProxy consegue resolver esses nomes via DNS ou /etc/hosts.

---

## 4. Inicialização do HAProxy
```bash
sudo systemctl enable --now haproxy
sudo systemctl status haproxy
```

---

## 5. Teste de funcionamento
- Conecte um cliente à porta 5672 do HAProxy e verifique se a conexão é distribuída entre os nodes RabbitMQ.
- Teste failover: pare um node RabbitMQ e veja se o HAProxy redireciona para os nodes ativos.

---

## 6. Alta disponibilidade do HAProxy (opcional)
- Para HA real, configure um VIP (Virtual IP) com Keepalived ou Pacemaker entre os dois nodes HAProxy.
- O VIP garante que, se um HAProxy falhar, o outro assume automaticamente.
- Exemplo de configuração de Keepalived pode ser fornecido conforme necessidade.

---

## 7. Observações
- Não é necessário ajuste nos nodes RabbitMQ para uso com HAProxy.
- Garanta que as portas estejam liberadas no firewall dos nodes HAProxy e RabbitMQ.
- Documente os IPs/hosts usados no balanceamento para facilitar troubleshooting.

---

> **Dica:** Para ambientes offline, mantenha todos os pacotes necessários em um repositório local ou mídia removível.
