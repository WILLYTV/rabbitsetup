# Preparação do ambiente no Red Hat 8

## 0. Verifique/instale o Podman

No Red Hat 8, o Podman pode ser instalado com:
```bash
sudo dnf install -y podman
```
Verifique se o comando está disponível:
```bash
podman --version
```

## 0.1. Crie o diretório para configuração do Prometheus

```bash
sudo mkdir -p /opt/prometheus
sudo chown $(whoami) /opt/prometheus
```

> **Observação:** O parâmetro `:Z` no comando `-v` do podman é necessário para compatibilidade com SELinux (ativo por padrão no RHEL 8).
# Como subir o Prometheus via Podman em um dos nodes RabbitMQ

## 1. Ative o plugin prometheus em todos os nodes RabbitMQ

Em cada node do cluster:
```bash
sudo rabbitmq-plugins enable rabbitmq_prometheus
```
Cada node irá expor métricas em `http://<NOME_DO_NODE>:15692/metrics`.

## 2. Escolha um node para rodar o Prometheus

Você pode rodar o Prometheus em qualquer node do cluster (ou em um servidor dedicado, se preferir). Para ambientes de teste/lab, rodar em um node RabbitMQ é aceitável.

## 3. Crie o arquivo prometheus.yml (apenas no node onde rodará o Prometheus)

No node nodeName01c (onde o Prometheus será instalado), crie o arquivo de configuração:
```bash
sudo nano /opt/prometheus/prometheus.yml
```

Cole o conteúdo abaixo, ajustando se necessário:
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['nodeName00c:15692', 'nodeName01c:15692', 'nodeName02c:15692', 'nodeName03c:15692', 'nodeName04c:15692']
```

Salve e feche o arquivo.

> **Importante:** O arquivo prometheus.yml é único e fica apenas no node nodeName01c (Prometheus). Não precisa replicar nos outros nodes.

## 4. Baixe a imagem oficial do Prometheus

### Download offline da imagem Prometheus

#### 4.1. No Windows (PowerShell) — baixar imagem

No seu computador com acesso à internet:
```powershell
podman pull docker.io/prom/prometheus:latest
podman save -o prometheus-latest.tar docker.io/prom/prometheus:latest
```

#### 4.2. Upload para o servidor

Transfira o arquivo `prometheus-latest.tar` para o servidor (ex: usando MobaXterm/SCP/SFTP) para a pasta `/tmp`.

#### 4.3. No servidor (offline) — importar imagem

No node nodeName01c:
```bash
cd /tmp
sudo podman load -i prometheus-latest.tar
```

---

## 5. Rode o container Prometheus

```bash
sudo podman run -d \
  --name prometheus \
  -p 9090:9090 \
  -v /opt/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:Z \
  docker.io/prom/prometheus:latest
```

## 6. Acesse a interface web do Prometheus

Abra no navegador:
```
http://<IP_DO_NODE>:9090
```

## 7. (Opcional) Parar/remover o container

```bash
podman stop prometheus
podman rm prometheus
```

---

> **Resumo:**
> - Ative o plugin prometheus em todos os nodes RabbitMQ.
> - O arquivo prometheus.yml é único e fica apenas no node onde o Prometheus roda.
> - O Prometheus coleta métricas de todos os nodes, centralizando a observabilidade.
# Observabilidade completa: Prometheus, Grafana e Alertas

## 1. Ativação do plugin Prometheus

- O plugin `rabbitmq_prometheus` deve ser ativado em **todos os nodes** do cluster:
  ```bash
  sudo rabbitmq-plugins enable rabbitmq_prometheus
  ```
- Cada node irá expor métricas em `http://<NOME_DO_NODE>:15692/metrics`.

## 2. Configuração do Prometheus

- O arquivo `prometheus.yml` é configurado **apenas no servidor onde o Prometheus roda** (não precisa replicar nos nodes RabbitMQ).
- Inclua todos os nodes RabbitMQ como targets:
  ```yaml
  scrape_configs:
    - job_name: 'rabbitmq'
      static_configs:
    - targets: ['nodeName00c:15692', 'nodeName01c:15692', 'nodeName02c:15692', 'nodeName03c:15692', 'nodeName04c:15692']
  ```
- Inicie o Prometheus apontando para esse arquivo:
  ```bash
  ./prometheus --config.file=prometheus.yml
  ```

## 3. Dashboards Grafana

- Instale o Grafana e adicione o Prometheus como data source.
- Importe dashboards prontos para RabbitMQ, como o oficial:
  - [RabbitMQ Overview (ID 10991)](https://grafana.com/grafana/dashboards/10991-rabbitmq-overview/)
- No Grafana: "+ Import" → cole o ID do dashboard → selecione o Prometheus como data source.

## 4. Alertas (Prometheus + Alertmanager)

- Configure regras de alerta no Prometheus, por exemplo:
  ```yaml
  groups:
    - name: rabbitmq-alerts
      rules:
        - alert: RabbitMQNodeDown
          expr: up{job="rabbitmq"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "RabbitMQ node está fora do ar"
  ```
- Configure o Alertmanager para enviar alertas por e-mail, Slack, etc.
  - [Guia oficial Alertmanager](https://prometheus.io/docs/alerting/latest/alertmanager/)

## 5. Fluxo resumido

1. Ative o plugin prometheus em todos os nodes RabbitMQ.
2. Configure o prometheus.yml no servidor Prometheus com todos os nodes como targets.
3. Suba o Prometheus e valide a coleta.
4. Adicione o Prometheus como data source no Grafana e importe dashboards.
5. Configure alertas conforme necessidade.

---

> **Dúvida frequente:**
> - O plugin prometheus deve ser ativado em cada node RabbitMQ.
> - O arquivo prometheus.yml é único e fica apenas no servidor Prometheus, centralizando a coleta de todos os nodes.
# 2.7 – Configuração de Monitoramento

Habilitar `rabbitmq_prometheus` e configurar Prometheus para coletar métricas.

Exemplo no `prometheus.yml`:
```yaml
scrape_configs:
  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['rabbit1:15692']
```
