# Instalar e validar **RabbitMQ 4.1.0** no RHEL 9 (air-gapped)

## 0) Pré-requisitos
- Erlang 27 já instalado e validado (compatível com RabbitMQ 4.x).
- Usuário com `sudo`.
- Porta **5672/tcp** (AMQP) e **15672/tcp** (Management UI) liberadas no firewall, caso queira acesso externo.

---

## 1) No Windows (PowerShell) — baixar arquivos

Crie/entre na pasta de staging:
```powershell
cd C:\erlang-rhel9-offline
```

Baixe o pacote do **RabbitMQ Server 4.1.0** (RPM para EL8, compatível com RHEL 9):
```powershell
curl.exe -o rabbitmq-server-4.1.0-1.el8.noarch.rpm "https://github.com/rabbitmq/rabbitmq-server/releases/download/v4.1.0/rabbitmq-server-4.1.0-1.el8.noarch.rpm"
```

Confirme o tamanho (~20 MB):
```powershell
Get-Item .\rabbitmq-server-4.1.0-1.el8.noarch.rpm | Select-Object Length
```

Se precisar também de dependências (`socat`, `logrotate`), baixe dos mirrors CentOS Stream 9 com o mesmo padrão de comando:
```powershell
curl.exe -o socat-1.7.4.1-5.el9.x86_64.rpm "http://mirror.stream.centos.org/9-stream/AppStream/x86_64/os/Packages/socat-1.7.4.1-5.el9.x86_64.rpm"
curl.exe -o logrotate-3.18.0-3.el9.x86_64.rpm "http://mirror.stream.centos.org/9-stream/BaseOS/x86_64/os/Packages/logrotate-3.18.0-3.el9.x86_64.rpm"
```

---

## 2) Upload para a VM

Mesmo processo usado no Erlang:

- **Painel SFTP (drag-and-drop)** → para `/tmp`  
- ou **SCP no PowerShell**:
```powershell
scp C:\erlang-rhel9-offline\rabbitmq-server-4.1.0-1.el8.noarch.rpm usuario@IP_DO_SERVIDOR:/tmp/
scp C:\erlang-rhel9-offline\socat-1.7.4.1-5.el9.x86_64.rpm usuario@IP_DO_SERVIDOR:/tmp/
scp C:\erlang-rhel9-offline\logrotate-3.18.0-3.el9.x86_64.rpm usuario@IP_DO_SERVIDOR:/tmp/
```

⚠️ **Ponto de atenção — 2FA**: cada upload pode abrir **sub-sessão** → aprove no app **2FA** sempre que solicitado.

---

## 3) Instalar na VM (offline)
Na VM:
```bash
cd /tmp
sudo dnf localinstall -y socat-*.rpm logrotate-*.rpm rabbitmq-server-*.rpm
```

Verifique:
```bash
rpm -qi rabbitmq-server
```

---

## 4) Habilitar e iniciar o serviço
```bash
sudo systemctl enable rabbitmq-server
sudo systemctl start rabbitmq-server
sudo systemctl status rabbitmq-server
```

---

## 5) Configurar usuário admin e Management UI
Ative o plugin de console:
```bash
sudo rabbitmq-plugins enable rabbitmq_management
```

Crie usuário admin (⚠️ use aspas simples para evitar erro de expansão de histórico no bash):
```bash
sudo rabbitmqctl add_user admin 'StrongPass!123'
```

Defina privilégios:
```bash
sudo rabbitmqctl set_user_tags admin administrator
sudo rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
```

---

## 6) Firewall (validação inicial vs produção)

### 6.1 Abrir portas para teste/validação (se `firewalld` estiver ativo)
```bash
sudo firewall-cmd --permanent --add-port=5672/tcp
sudo firewall-cmd --permanent --add-port=15672/tcp
sudo firewall-cmd --reload
```

### 6.2 Caso apareça a mensagem **"FirewallD is not running"**
Isso significa que o servidor não usa `firewalld` localmente.  
Nessa situação:  
- As portas já estarão acessíveis conforme a política de rede.  
- O controle de acesso provavelmente é feito em **firewalls externos** ou regras corporativas de rede.  
- Para produção, alinhar com o time de segurança/rede se as portas devem ser expostas diretamente ou publicadas via proxy/VPN.

---

## 7) Validar

### 7.1 Validar serviço
```bash
sudo systemctl status rabbitmq-server
```

### 7.2 Validar console de administração (UI)
Descubra o nome da máquina (hostname) e/ou IP para montar o link de acesso externo:

```bash
hostname       # nome curto
hostname -f    # FQDN (se configurado)
hostname -I    # IP(s) da máquina
```

Exemplo de acesso pelo browser (do seu desktop):  
```
http://NOME-DA-MAQUINA:15672
ou
http://IP-DA-MAQUINA:15672
```

→ login: `admin / StrongPass!123`

---

## 8) Troubleshooting rápido
- **Erro de dependência no `localinstall`** → baixe os RPMs EL9 faltantes e instale junto (`sudo dnf localinstall -y *.rpm`).  
- **Serviço não sobe** → veja logs:
  ```bash
  sudo journalctl -u rabbitmq-server -f
  ```
- **Permissões negadas** → confirme que está rodando como `sudo` e que o diretório `/var/lib/rabbitmq/` pertence ao usuário `rabbitmq`.
