# Instalar e validar **RabbitMQ** no RHEL 9 (air-gapped)

## 0) Pré-requisitos
- Erlang já instalado e validado.
- Usuário com `sudo`.
- Porta **5672/tcp** (AMQP) e **15672/tcp** (Management UI) liberadas no firewall, caso queira acesso externo.

---

## 1) No Windows (PowerShell) — baixar arquivos
Crie/entre na pasta de staging:
```powershell
cd C:\erlang-rhel9-offline
```

Baixe o pacote do **RabbitMQ Server** (RPM para EL9, `noarch`):
```powershell
Invoke-WebRequest -Uri "https://github.com/rabbitmq/rabbitmq-server/releases/download/v4.0.4/rabbitmq-server-4.0.4-1.el9.noarch.rpm" -OutFile "rabbitmq-server-4.0.4-1.el9.noarch.rpm"
```

Baixe também dependências típicas:
```powershell
Invoke-WebRequest -Uri "http://mirror.centos.org/centos/9-stream/AppStream/x86_64/os/Packages/socat-1.7.4.1-5.el9.x86_64.rpm" -OutFile "socat-1.7.4.1-5.el9.x86_64.rpm"
```
> `socat` é necessário para plugins de CLI e clustering.  
> Se sua VM não tiver `logrotate`, baixe também `logrotate-*.el9.x86_64.rpm`.

(Conferir integridade, opcional:)
```powershell
Get-FileHash .\rabbitmq-server-4.0.4-1.el9.noarch.rpm -Algorithm SHA256
```

---

## 2) Upload para a VM
Mesmo processo usado no Erlang:

- **Painel SFTP (drag-and-drop)** → para `/tmp`  
- ou **SCP no PowerShell**:
```powershell
scp C:\erlang-rhel9-offline\rabbitmq-server-4.0.4-1.el9.noarch.rpm usuario@IP_DO_SERVIDOR:/tmp/
scp C:\erlang-rhel9-offline\socat-1.7.4.1-5.el9.x86_64.rpm usuario@IP_DO_SERVIDOR:/tmp/
```

⚠️ **Ponto de atenção — 2FA**: cada upload pode abrir **sub-sessão** → aprove no app **2FA** sempre que solicitado.

---

## 3) Instalar na VM (offline)
Na VM:
```bash
cd /tmp
sudo dnf localinstall -y socat-*.rpm
sudo dnf localinstall -y rabbitmq-server-*.noarch.rpm
```

Verifique:
```bash
rpm -qi rabbitmq-server
```

---

## 4) Habilitar e iniciar o serviço
```bash
sudo systemctl enable rabbitmq-server
sudo systemctl start rabbitmq-server
sudo systemctl status rabbitmq-server
```

---

## 5) Configurar usuário admin e Management UI
Ative o plugin de console:
```bash
sudo rabbitmq-plugins enable rabbitmq_management
```

Crie usuário admin:
```bash
sudo rabbitmqctl add_user admin StrongPass!123
sudo rabbitmqctl set_user_tags admin administrator
sudo rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
```

---

## 6) Firewall (se quiser acessar de fora da VM)
```bash
sudo firewall-cmd --permanent --add-port=5672/tcp
sudo firewall-cmd --permanent --add-port=15672/tcp
sudo firewall-cmd --reload
```

---

## 7) Validar
- Serviço:
```bash
sudo systemctl status rabbitmq-server
```
- UI: abrir no navegador  
  ```
  http://IP_DA_VM:15672
  ```
  → login: `admin / StrongPass!123`

---

## 8) Troubleshooting rápido
- **Erro de dependência no `localinstall`** → baixe os RPMs EL9 faltantes e instale junto (`sudo dnf localinstall -y *.rpm`).  
- **Serviço não sobe** → veja logs:
  ```bash
  sudo journalctl -u rabbitmq-server -f
  ```
- **Permissões negadas** → confirme que está rodando como `sudo` e que o diretório `/var/lib/rabbitmq/` pertence ao usuário `rabbitmq`.
